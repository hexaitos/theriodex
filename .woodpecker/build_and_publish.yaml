when:
  branch: main
  event: [push, pull_request]

variables:
  - &file Dockerfile
  - &repo https://codeberg.org/${CI_REPO_OWNER}/theriodex

steps:
  build:
    image: woodpeckerci/plugin-kaniko
    settings:
      dockerfile: *file
      platforms: linux/amd64
      repo: *repo
      tags: latest

  publish_to_codeberg:
    image: woodpeckerci/plugin-kaniko
    settings:
      dockerfile: *file
      platforms: linux/amd64
      repo: *repo
      tags: latest
      username: ${CI_REPO_OWNER}
      password:
        from_secret: cb_token

  publish_to_scaleway:
    image: woodpeckerci/plugin-kaniko
    settings:
      dockerfile: *file
      platforms: linux/amd64
      repo:
        from_secret: scaleway_repo
      tags: latest
      username: nologin
      password:
        from_secret: scw_key

  deploy:
    image: debian
    environment:
      SCW_SECRET_KEY:
        from_secret: scw_key
      CONTAINER_REGION:
        from_secret: container_region
      CONTAINER_ID:
        from_secret: container_id
    commands:
      - |
        curl -X POST -H "X-Auth-Token: $SCW_SECRET_KEY" -H "Content-Type: application/json" -d '{}' "https://api.scaleway.com/containers/v1beta1/regions/$CONTAINER_REGION/containers/$CONTAINER_ID/deploy"
